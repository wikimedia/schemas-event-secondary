{
  "title": "analytics/mediawiki/client/metrics_event",
  "description": "The schema defines:\n\n1. The standard contextual attributes that can be recorded when a user\n   performs an instrumented interaction with a MediaWiki instance; and\n\n2. The standard shape of the events that model those instrumented\n   interactions.\n\nThese attributes convey information about the who, what, when, and where of\nthe instrumented interaction. They are sent alongside a databag of custom\ndata, which is provided by the instrument. The databag of custom data\nconveys information about the how of the instrumented interaction.\n\nThe attributes are collected by many instruments in many products and are\nare used in many kinds of analysis. To ensure these attributes are being\nimplemented faithfully, the Metrics Platform is responsible for assigning\nvalues to them.\n\nSee https://wikitech.wikimedia.org/wiki/Metrics_Platform for more detail.",
  "$id": "/analytics/mediawiki/client/metrics_event/1.0.0",
  "$schema": "https://json-schema.org/draft-07/schema#",
  "type": "object",
  "additionalProperties": false,
  "examples": [
    {
      "$schema": "/analytics/mediawiki/client/metrics_event/1.0.0",
      "dt": "2022-02-10T14:28:00.000Z",
      "name": "desktop_web_ui_actions.click",
      "custom_data": {
        "action": {
          "data_type": "string",
          "value": "init"
        },
        "is_sidebar_collapsed": {
          "data_type": "boolean",
          "value": "false"
        }
      },
      "meta": {
        "stream": "desktop_web_ui_actions",
        "dt": "2022-02-10T14:28:00.250Z"
      },
      "agent": {
        "client_platform": "mediawiki_js",
        "client_platform_family": "desktop_browser"
      },
      "performer": {
        "is_logged_in": false,
        "edit_count_bucket": "0 edits"
      },
      "mediawiki": {
        "skin": "vector"
      }
    },
    {
      "$schema": "/analytics/mediawiki/client/metrics_event/1.0.0",
      "dt": "2022-02-14T12:00:00.000Z",
      "name": "desktop_web_ui_actions.click",
      "custom_data": {
        "action": {
          "data_type": "string",
          "value": "click"
        },
        "name": {
          "data_type": "string",
          "value": "ui.dropdown-p-variants"
        },
        "is_sidebar_collapsed": {
          "data_type": "boolean",
          "value": "false"
        }
      },
      "meta": {
        "stream": "desktop_web_ui_actions",
        "dt": "2022-02-14T12:00:00.500Z"
      },
      "agent": {
        "client_platform": "mediawiki_js",
        "client_platform_family": "desktop_browser"
      },
      "performer": {
        "is_logged_in": true,
        "edit_count_bucket": "5-99 edits"
      },
      "mediawiki": {
        "skin": "vector-2022"
      }
    }
  ],
  "required": [
    "$schema",
    "meta"
  ],
  "properties": {
    "$schema": {
      "description": "A URI identifying the JSONSchema for this event. This should match an schema's $id in a schema repository. E.g. /schema/title/1.0.0\n",
      "type": "string"
    },
    "dt": {
      "description": "ISO-8601 formatted timestamp of when the event occurred/was generated in UTC). This exists separately from meta.dt in the main common schema. For external client-sent instrumentation events, we want to allow meta.dt to be the received time (filled in by EventGate at ingest time), as we don't trust client-sent events to always set the proper date and time. Client-set event generation time should be set here instead. See: https://phabricator.wikimedia.org/T240460\n",
      "type": "string",
      "format": "date-time",
      "maxLength": 128
    },
    "http": {
      "type": "object",
      "properties": {
        "has_cookies": {
          "description": "True if the http request has any cookies set",
          "type": "boolean"
        },
        "method": {
          "description": "The HTTP request method (GET, POST, etc.)",
          "type": "string"
        },
        "protocol": {
          "description": "The protocol used for the request (HTTP or HTTPS)",
          "type": "string"
        },
        "request_headers": {
          "description": "Request headers sent by the client.  E.g. user-agent, etc.",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "response_headers": {
          "description": "Response headers sent back to the client (when known).",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "status_code": {
          "description": "The HTTP status code returned for this request (when known)",
          "type": "integer",
          "maximum": 9007199254740991,
          "minimum": -9007199254740991
        }
      }
    },
    "meta": {
      "type": "object",
      "required": [
        "dt",
        "stream"
      ],
      "properties": {
        "domain": {
          "description": "Domain the event or entity pertains to",
          "type": "string",
          "minLength": 1
        },
        "dt": {
          "description": "UTC event datetime, in ISO-8601 format",
          "type": "string",
          "format": "date-time",
          "maxLength": 128
        },
        "id": {
          "description": "Unique ID of this event",
          "type": "string"
        },
        "request_id": {
          "description": "Unique ID of the request that caused the event",
          "type": "string"
        },
        "stream": {
          "description": "Name of the stream/queue/dataset that this event belongs in",
          "type": "string",
          "minLength": 1
        },
        "uri": {
          "description": "Unique URI identifying the event or entity",
          "type": "string",
          "format": "uri-reference",
          "maxLength": 8192
        }
      }
    },
    "name": {
      "type": "string",
      "mexLength": 128,
      "description": "The name of the event. All events have a name used to identify\nthem. This name is passed in by the instrumentation code, and is\nalso used by event stream configuration subscribers to identify\nwhich events they would like to appear in the stream."
    },
    "agent": {
      "type": "object",
      "description": "Information related to the Metrics Platform client - the agent\nresponsible for logging the event.",
      "additionalProperties": false,
      "properties": {
        "app_install_id": {
          "type": "string",
          "minLength": 36,
          "maxLength": 36,
          "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
          "description": "UUIDv4 identifier generated when an application is installed.\nIdentifies a particular install on a particular device."
        },
        "client_platform": {
          "type": "string",
          "enum": [
            "mediawiki_php",
            "mediawiki_js",
            "kaios",
            "android",
            "ios"
          ],
          "description": "The client platform on which the event was produced."
        },
        "client_platform_family": {
          "type": "string",
          "enum": [
            "mobile_browser",
            "desktop_browser",
            "app"
          ],
          "description": "The family of the client platform on which which the event was\nproduced."
        }
      }
    },
    "page": {
      "type": "object",
      "description": "Information about the current page",
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "integer",
          "minimum": -1,
          "description": "Unique identifier assigned to a MediaWiki page when it is created.\nThe identifier remains the same across edits, renames, and moves.\nIt may change if the page is deleted and then restored, however.\n\nSee https://www.mediawiki.org/wiki/Manual:Page_table#page_id",
          "maximum": 9007199254740991
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "The MediaWiki page title, with the namespace prefix removed\nand with spaces replaced by underscores, e.g. \"Talk:Foo Bar\"\nbecomes \"Foo_Bar\"\n\nSee https://www.mediawiki.org/wiki/Manual:Page_title and\nhttps://www.mediawiki.org/wiki/Manual:Page_table#page_title"
        },
        "namespace": {
          "type": "integer",
          "description": "The ID of the namespace that the page is in.\n\nSee\n * https://www.mediawiki.org/wiki/Manual:Namespace\n * https://www.mediawiki.org/wiki/Manual:Using_custom_namespaces",
          "minimum": -9007199254740991,
          "maximum": 9007199254740991
        },
        "namespace_name": {
          "type": "string",
          "minLength": 0,
          "description": "The canonical (English) name of the namespace that the page is\nin.\n\nNamespace names can be translated and translatable aliases can\nbe created for them in the MediaWiki configuration. MediaWiki\nCore defines the canonical name for a namespace as the English\none.\n\nSee\n * https://www.mediawiki.org/wiki/Manual:Namespace and\n * https://www.mediawiki.org/wiki/Manual:Using_custom_namespaces"
        },
        "revision_id": {
          "type": "integer",
          "minimum": 0,
          "description": "The head revision ID of the page at the time of the event.",
          "maximum": 9007199254740991
        },
        "wikidata_id": {
          "type": "integer",
          "description": "Wikibase item ID corresponding to the page at the time of the event.\n\nSee https://www.wikidata.org/wiki/Wikidata:Identifiers",
          "minimum": -9007199254740991,
          "maximum": 9007199254740991
        },
        "content_language": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "The language of the page content, formatted as a language code.\n\nSemantics to be documented as the \"page content language algorithm\".\n\nSee\n * https://www.mediawiki.org/wiki/Manual:Language\n * https://meta.wikimedia.org/wiki/Language_codes\n * https://www.mediawiki.org/wiki/Manual:Language#Language_code"
        },
        "is_redirect": {
          "type": "boolean",
          "description": "Whether the MediaWiki page is a redirect or not at the time of the\nevent. A page is considered a redirect if it starts with\n\n    #REDIRECT [[pagename]]\n\nNote well that this state is also stored on the Mediawiki page\ntable.\n\nSee\n * https://www.mediawiki.org/wiki/Help:Redirects\n * https://www.mediawiki.org/wiki/Manual:Page_table#page_is_redirect"
        },
        "user_groups_allowed_to_move": {
          "type": "array",
          "description": "User groups with permission to move the page at the time of the event.\n\nThis will be an empty array if any user is allowed to move the page.",
          "items": {
            "type": "string"
          }
        },
        "user_groups_allowed_to_edit": {
          "type": "array",
          "description": "User groups with permission to edit the page at the time of the event.\n\nThis will be an empty array if any user is allowed to edit the page.",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "mediawiki": {
      "type": "object",
      "description": "Information related to the MediaWiki instance that the user is\naccessing.",
      "additionalProperties": false,
      "properties": {
        "skin": {
          "type": "string",
          "minLength": 1,
          "description": "MediaWiki skin (e.g. \"vector\") at the time of the event."
        },
        "version": {
          "type": "string",
          "description": "MediaWiki version at the time of the event, e.g \"1.38.0-wmf.18\"."
        },
        "is_production": {
          "type": "boolean",
          "description": "Whether the MediaWiki instance is considered to be running in\nproduction, e.g. mediawikiwiki."
        },
        "is_debug_mode": {
          "type": "boolean",
          "description": "Whether the MediaWiki instance is considered to be running in\ndebug mode."
        },
        "site_content_language": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "The site content language, formatted as a language code.\n\nSee\n * https://www.mediawiki.org/wiki/Manual:Language\n * https://meta.wikimedia.org/wiki/Language_codes\n * https://www.mediawiki.org/wiki/Manual:Language#Language_code"
        },
        "site_content_language_variant": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "The site content language variant, formatted as a language code.\n\nSee\n * https://www.mediawiki.org/wiki/Manual:Language\n * https://meta.wikimedia.org/wiki/Language_codes\n * https://www.mediawiki.org/wiki/Manual:Language#Language_code"
        }
      }
    },
    "performer": {
      "type": "object",
      "description": "Information about the user accessing the content and/or performing\nthe action, often referred to as the actor or the \"global user\" in\nMediaWiki Core, extensions, and skins.\n\nFor context about the use of \"performer\" rather than \"actor\", see\nhttps://phabricator.wikimedia.org/T167246#5093402 onwards.",
      "additionalProperties": false,
      "properties": {
        "is_logged_in": {
          "type": "boolean",
          "description": "Whether the user is currently logged in."
        },
        "id": {
          "type": "integer",
          "minLength": 1,
          "description": "The ID associated with the user account.\n\nUser must be be logged in for the property to appear.",
          "minimum": -9007199254740991,
          "maximum": 9007199254740991
        },
        "name": {
          "type": "string",
          "description": "The username associated with the user account.\n\nUser must be be logged in for the property to appear."
        },
        "session_id": {
          "type": "string",
          "minLength": 20,
          "maxLength": 20,
          "pattern": "^[0-9a-z]{20}$",
          "description": "Eighty uniform random bits formatted as a string of twenty\nhexadecimal digits. Identifies a single user session."
        },
        "pageview_id": {
          "type": "string",
          "minLength": 20,
          "maxLength": 20,
          "pattern": "^[0-9a-z]{20}$",
          "description": "Eighty uniform random bits formatted as a string of twenty\nhexadecimal digits. Identifies a single pageview within a user\nsession."
        },
        "groups": {
          "type": "array",
          "description": "Groups that the user is in at the time of the event.",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "is_bot": {
          "type": "boolean",
          "description": "Whether the user is considered a bot at the time of the event.\n\nA user is considered a bot if they are in the \"bot\" group and\nif they have the \"bot\" right."
        },
        "language": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "The user's language at the time of the event, formatted as a\nlanguage code.\n\nUser must be logged in for attribute to appear.\n\nSee\n - https://www.mediawiki.org/wiki/Manual:Language\n - https://meta.wikimedia.org/wiki/Language_codes\n - https://www.mediawiki.org/wiki/Manual:Language#Language_code"
        },
        "language_variant": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "The user's language variant at the time of the event, formatted\nas a language code.\n\nUser must be logged in for attribute to appear.\n\nSee\n - https://www.mediawiki.org/wiki/Manual:Language\n - https://meta.wikimedia.org/wiki/Language_codes\n - https://www.mediawiki.org/wiki/Manual:Language#Language_code\n\nTODO: Documented how the user's language variant is determined."
        },
        "can_probably_edit_page": {
          "type": "boolean",
          "description": "True if the current page at the time of the event is editable by\nthe user, given the user and page's permissions.\n\nUser must be be logged in for attribute to appear.\n\nTODO: Semantics to be documented as the \"user can probably edit\npage algorithm\""
        },
        "edit_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of edits that the user has performed at the time of the\nevent.\n\nUser must be be logged in for attribute to appear.",
          "maximum": 9007199254740991
        },
        "edit_count_bucket": {
          "type": "string",
          "enum": [
            "0 edits",
            "1-4 edits",
            "5-99 edits",
            "100-999 edits",
            "1000+ edits"
          ],
          "description": "The number of edits that the user has performed at the time of\nthe event placed into one five low-granularity buckets.\n\nUser must be be logged in for attribute to appear."
        },
        "registration_dt": {
          "type": "string",
          "format": "date-time",
          "maxLength": 128,
          "description": "Datetime when the user account was registered.\n\nUser must be be logged in for attribute to appear."
        }
      }
    },
    "custom_data": {
      "type": "object",
      "propertyNames": {
        "pattern": "^[$a-z]+[a-z0-9_]*$",
        "minLength": 1,
        "maxLength": 255
      },
      "properties": {
        "data_type": {
          "type": "string",
          "enum": [
            "number",
            "string",
            "boolean",
            null
          ]
        },
        "value": {
          "type": "string"
        }
      }
    }
  }
}